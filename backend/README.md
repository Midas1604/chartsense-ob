# ChartSense OB Backend API

API backend para an√°lise de gr√°ficos de trading usando OpenAI Vision e Supabase.

## üöÄ Funcionalidades

- **An√°lise de Gr√°ficos**: Upload de imagens e an√°lise usando OpenAI GPT-4o-mini com Structured Outputs
- **Armazenamento**: Persist√™ncia no Supabase (PostgreSQL + Storage)
- **Rate Limiting**: Prote√ß√£o contra abuso
- **Valida√ß√£o**: Valida√ß√£o rigorosa de dados de entrada
- **Logging**: Sistema de logs estruturado com Pino
- **Docker**: Containeriza√ß√£o para deploy f√°cil
- **OpenAPI**: Documenta√ß√£o completa da API
- **RLS Security**: Row Level Security configurado no Supabase

## üìã Pr√©-requisitos

- Node.js 18+
- npm ou yarn
- Conta no Supabase
- Chave da API OpenAI

## ‚öôÔ∏è Configura√ß√£o

### 1. Instalar depend√™ncias

```bash
npm install
```

### 2. Configurar vari√°veis de ambiente

Copie o arquivo `.env.example` para `.env` e configure:

```bash
cp .env.example .env
```

Edite o arquivo `.env`:

```env
# Servidor
PORT=8787
NODE_ENV=development

# OpenAI
OPENAI_API_KEY=sk-your-openai-api-key-here

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
SUPABASE_ANON_KEY=your-anon-key-here

# Logs
LOG_LEVEL=debug
```

### 3. Configurar Supabase

#### 3.1 Executar migra√ß√µes SQL

Execute os arquivos SQL no SQL Editor do Supabase:

1. `src/db/migrations.sql` - Criar tabelas
2. `src/db/rls_policies.sql` - Configurar seguran√ßa RLS

#### 3.2 Criar buckets de Storage

No painel do Supabase, v√° em Storage e crie:

- **charts**: Para imagens de gr√°ficos (limite 10MB)
- **reports**: Para relat√≥rios opcionais (limite 50MB)

#### 3.3 Configurar pol√≠ticas de Storage

Execute as pol√≠ticas de seguran√ßa conforme `SUPABASE_STORAGE_SETUP.md`.

## üèÉ‚Äç‚ôÇÔ∏è Executar

### Desenvolvimento

```bash
npm run dev
```

### Produ√ß√£o

```bash
npm run build
npm start
```

### Docker

```bash
# Build da imagem
docker build -t chartsense-backend .

# Executar container
docker run -p 8787:8787 --env-file .env chartsense-backend

# Ou usar docker-compose
docker-compose up -d
```

## üìö Documenta√ß√£o da API

### Endpoints Principais

#### POST /analyze
Analisa um gr√°fico enviado via imagem.

**Request:**
```json
{
  "asset": "EUR/USD",
  "timeframe": "M15",
  "strategy": "Order Blocks",
  "imagePath": "charts/user123/chart-abc123.png",
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",
  "message": "An√°lise iniciada com sucesso"
}
```

#### GET /analyses/:id
Busca uma an√°lise espec√≠fica pelo ID.

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "asset": "EUR/USD",
  "timeframe": "M15",
  "strategy": "Order Blocks",
  "status": "done",
  "result_json": {
    "summary": "An√°lise do gr√°fico EUR/USD...",
    "trend": "alta",
    "key_levels": [...],
    "signals": [...],
    "risk_notes": "..."
  },
  "created_at": "2024-01-01T12:00:00Z"
}
```

#### GET /history
Lista hist√≥rico de an√°lises com filtros opcionais.

**Query Parameters:**
- `userId` (UUID): Filtrar por usu√°rio
- `asset` (string): Filtrar por ativo (ex: "EUR/USD")
- `timeframe` (string): Filtrar por timeframe (ex: "M15")
- `limit` (number): Limite de resultados (1-100, padr√£o: 20)

**Response:**
```json
{
  "analyses": [...],
  "total": 15,
  "filters": {
    "asset": "EUR/USD",
    "timeframe": "M15",
    "limit": 20
  }
}
```

#### POST /feedback
Envia feedback sobre uma an√°lise.

**Request:**
```json
{
  "analysisId": "550e8400-e29b-41d4-a716-446655440000",
  "rating": 5,
  "comment": "An√°lise muito precisa!"
}
```

**Response:**
```json
{
  "message": "Feedback registrado com sucesso",
  "analysisId": "550e8400-e29b-41d4-a716-446655440000",
  "rating": 5,
  "comment": "An√°lise muito precisa!"
}
```

#### GET /health
Health check da API.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T12:00:00Z",
  "version": "1.0.0",
  "environment": "production"
}
```

### Documenta√ß√£o OpenAPI

Acesse `http://localhost:8787/openapi.yaml` para ver a documenta√ß√£o completa.

## üß™ Exemplos de Uso com cURL

### 1. Analisar gr√°fico

```bash
curl -X POST http://localhost:8787/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "asset": "EUR/USD",
    "timeframe": "M15",
    "strategy": "Order Blocks",
    "imagePath": "charts/user123/chart-abc123.png",
    "userId": "550e8400-e29b-41d4-a716-446655440000"
  }'
```

### 2. Buscar an√°lise espec√≠fica

```bash
curl http://localhost:8787/analyses/550e8400-e29b-41d4-a716-446655440000
```

### 3. Buscar hist√≥rico com filtros

```bash
# Hist√≥rico geral
curl "http://localhost:8787/history?limit=10"

# Filtrado por asset
curl "http://localhost:8787/history?asset=EUR/USD&limit=5"

# Filtrado por timeframe
curl "http://localhost:8787/history?timeframe=M15&limit=20"

# M√∫ltiplos filtros
curl "http://localhost:8787/history?asset=GBP/USD&timeframe=H1&limit=10"
```

### 4. Enviar feedback

```bash
curl -X POST http://localhost:8787/feedback \
  -H "Content-Type: application/json" \
  -d '{
    "analysisId": "550e8400-e29b-41d4-a716-446655440000",
    "rating": 5,
    "comment": "An√°lise muito precisa!"
  }'
```

### 5. Health check

```bash
curl http://localhost:8787/health
```

## üîí Seguran√ßa

### Rate Limiting

- **An√°lises**: 10 por IP a cada 15 minutos
- **Geral**: 100 requests por IP a cada 15 minutos

### Valida√ß√£o de Imagens

- Tamanho m√°ximo: 10MB
- Verifica√ß√£o no Supabase Storage antes da an√°lise
- Valida√ß√£o de formato e integridade

### RLS (Row Level Security)

- Usu√°rios s√≥ acessam seus pr√≥prios dados
- Pol√≠ticas configuradas no Supabase
- Autentica√ß√£o via JWT tokens

## üèóÔ∏è Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ routes/          # Rotas da API
‚îÇ   ‚îú‚îÄ‚îÄ analyze.ts   # POST /analyze
‚îÇ   ‚îú‚îÄ‚îÄ history.ts   # GET /analyses/:id, /history
‚îÇ   ‚îî‚îÄ‚îÄ feedback.ts  # POST /feedback
‚îú‚îÄ‚îÄ services/        # Servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ openai.ts    # Integra√ß√£o OpenAI (gpt-4o-mini + Structured Outputs)
‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts  # Integra√ß√£o Supabase
‚îÇ   ‚îî‚îÄ‚îÄ logger.ts    # Sistema de logs
‚îú‚îÄ‚îÄ middleware/      # Middlewares
‚îÇ   ‚îî‚îÄ‚îÄ index.ts     # Rate limiting, valida√ß√£o, CORS
‚îú‚îÄ‚îÄ types/           # Tipos TypeScript
‚îÇ   ‚îî‚îÄ‚îÄ index.ts     # Interfaces e tipos
‚îú‚îÄ‚îÄ db/              # Scripts de banco
‚îÇ   ‚îú‚îÄ‚îÄ migrations.sql
‚îÇ   ‚îî‚îÄ‚îÄ rls_policies.sql
‚îî‚îÄ‚îÄ server.ts        # Servidor principal
```

## üß™ Desenvolvimento

### Scripts dispon√≠veis

```bash
npm run dev      # Desenvolvimento com hot reload
npm run build    # Build para produ√ß√£o
npm start        # Executar vers√£o buildada
npm run lint     # Linter
npm run lint:fix # Corrigir problemas do linter
```

### Logs

Os logs s√£o estruturados usando Pino:

- **Desenvolvimento**: Pretty print colorido
- **Produ√ß√£o**: JSON estruturado

### Tratamento de Erros

- Erros s√£o capturados e logados
- Respostas padronizadas para o cliente
- Status de an√°lise atualizado em caso de erro

## üöÄ Deploy

### Railway

1. Conecte seu reposit√≥rio no Railway
2. Configure as vari√°veis de ambiente:
   ```
   NODE_ENV=production
   PORT=8787
   OPENAI_API_KEY=sk-...
   SUPABASE_URL=https://...
   SUPABASE_SERVICE_ROLE_KEY=...
   LOG_LEVEL=info
   ```
3. Deploy autom√°tico via Git

### Render

1. Conecte seu reposit√≥rio no Render
2. Configure o servi√ßo:
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Port**: 8787
3. Configure as vari√°veis de ambiente
4. Deploy autom√°tico

### Vercel (Serverless)

1. Instale a CLI do Vercel: `npm i -g vercel`
2. Configure `vercel.json`:
   ```json
   {
     "version": 2,
     "builds": [
       {
         "src": "src/server.ts",
         "use": "@vercel/node"
       }
     ],
     "routes": [
       {
         "src": "/(.*)",
         "dest": "src/server.ts"
       }
     ]
   }
   ```
3. Deploy: `vercel --prod`

### Docker (Produ√ß√£o)

```bash
# Build
docker build -t chartsense-backend .

# Run com todas as features
docker-compose --profile production up -d

# Run b√°sico
docker-compose up -d chartsense-backend
```

### Vari√°veis de Ambiente (Produ√ß√£o)

```env
NODE_ENV=production
PORT=8787
OPENAI_API_KEY=sk-...
SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=...
SUPABASE_ANON_KEY=...
LOG_LEVEL=info
```

## üîß Troubleshooting

### Problemas Comuns

1. **Erro de conex√£o Supabase**
   - Verifique as vari√°veis de ambiente
   - Confirme se as tabelas foram criadas
   - Teste a conex√£o no SQL Editor

2. **Erro OpenAI**
   - Verifique a chave da API
   - Confirme se h√° cr√©ditos dispon√≠veis
   - Teste com uma imagem menor

3. **Imagem n√£o encontrada**
   - Verifique se o arquivo existe no Storage
   - Confirme as pol√≠ticas de acesso
   - Teste o signedUrl manualmente

4. **Rate limit**
   - Aguarde o tempo de reset
   - Configure limites personalizados se necess√°rio

5. **Erro de build TypeScript**
   - Execute `npm run build` localmente
   - Verifique tipos e imports

### Logs √öteis

```bash
# Ver logs em tempo real
docker-compose logs -f chartsense-backend

# Filtrar por n√≠vel
docker-compose logs chartsense-backend | grep ERROR

# Logs de desenvolvimento
npm run dev | grep "analysis"
```

### Debugging

```bash
# Testar conex√£o Supabase
curl -H "apikey: YOUR_ANON_KEY" \
     -H "Authorization: Bearer YOUR_ANON_KEY" \
     "https://your-project.supabase.co/rest/v1/analyses?select=*&limit=1"

# Testar OpenAI
curl -H "Authorization: Bearer YOUR_OPENAI_KEY" \
     -H "Content-Type: application/json" \
     -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"test"}]}' \
     "https://api.openai.com/v1/chat/completions"
```

## üìä Monitoramento

### Health Checks

- **Endpoint**: `/health`
- **Docker**: Health check configurado
- **Uptime**: Monitore via Railway/Render dashboard

### M√©tricas

- Rate limiting: Headers `X-RateLimit-*`
- Response times: Logs estruturados
- Error rates: Logs de erro

### Alertas

Configure alertas para:
- API down (health check fail)
- High error rate (>5%)
- Rate limit exceeded
- OpenAI quota exceeded

## üìÑ Licen√ßa

MIT License - veja o arquivo LICENSE para detalhes.

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature
3. Commit suas mudan√ßas
4. Push para a branch
5. Abra um Pull Request

## üìû Suporte

Para suporte, abra uma issue no GitHub ou entre em contato:

- Email: support@chartsense.com
- GitHub: [ChartSense Issues](https://github.com/chartsense/backend/issues)

---

**‚ö†Ô∏è Aviso Legal**: Este sistema √© para fins educacionais. N√£o constitui aconselhamento financeiro.